import '../resources/constants.dart';

String podoStub(
    {required String modelName,
    required Map<String, dynamic> fields,
    bool iterable = false,
    bool serializable = true}) {
  if (serializable && !iterable) {
    return _singleSerializablePodoStub(modelName, fields);
  }

  if (serializable && iterable) {
    return _iterableSerializablePodoStub(modelName, fields);
  }

  return _plainPodoStub(modelName, fields);
}

String _singleSerializablePodoStub(
    String modelName, Map<String, dynamic> fields) {
  return '''
${_stamp()}
${_buildGeneralImports()}
${_buildSerializationImports(modelName)}
${_buildSerializationAnnotation()}
${_buildClassHeader(modelName, true)}
${_buildClassFields(fields)}
${_buildClassConstructor(modelName, fields)}
${_buildSerializable(modelName)} 
${_buildParse(modelName, true)}
}
''';
}

String _iterableSerializablePodoStub(
    String modelName, Map<String, dynamic> fields) {
  return '''
${_stamp()}
${_buildGeneralImports()}
${_buildSerializationImports(modelName)}
${_buildSerializationAnnotation()}
${_buildClassHeader(modelName, true)}
${_buildClassFields(fields)}
${_buildClassConstructor(modelName, fields)}
${_buildSerializable(modelName)} 
${_buildParse(modelName, true)}
${_buildDynamicParse(modelName, true, true)}
}
''';
}

String _plainPodoStub(String modelName, Map<String, dynamic> fields) {
  return '''
${_stamp()}
${_buildGeneralImports()}

${_buildClassHeader(modelName, false)}
${_buildClassFields(fields)}
${_buildClassConstructor(modelName, fields)}
}
''';
}

String _stamp() {
  return '''
// **************************************************************************
// GENERATED BY ULTRON @ ${DateTime.now()}
// **************************************************************************''';
}

String _buildGeneralImports() {
  final StringBuffer importsBuffer = StringBuffer();
  importsBuffer.writeln();
  importsBuffer.writeln('import \'exports.dart\';');
  return importsBuffer.toString().removeLast();
}

String _buildSerializationImports(String modelName) {
  final StringBuffer importsBuffer = StringBuffer();
  importsBuffer.writeln();
  importsBuffer.writeln('import \'package:fly_networking/fly.dart\';');
  importsBuffer
      .writeln('import \'package:json_annotation/json_annotation.dart\';');
  importsBuffer.writeln();
  importsBuffer.writeln('part \'${modelName.toLowerCase()}.g.dart\';');
  return importsBuffer.toString().removeLast();
}

String _buildSerializationAnnotation() {
  return '''
  
@JsonSerializable()''';
}

String _buildClassHeader(String modelName, bool serializable) {
  if (!serializable) return 'class $modelName {';
  return 'class $modelName with Parser<$modelName> {';
}

String _buildClassFields(Map<String, dynamic> fields) {
  final StringBuffer fieldsBuffer = StringBuffer();

  fields.forEach((fieldName, fieldType) {
    fieldsBuffer.writeln('  final $fieldType? $fieldName;');
  });
  return fieldsBuffer.toString();
}

String _buildClassConstructor(String modelName, Map<String, dynamic> fields) {
  final StringBuffer constructorBuffer = StringBuffer();
  constructorBuffer.writeln('\t$modelName({');

  fields.forEach((fieldName, _) {
    constructorBuffer.writeln('\t\tthis.$fieldName,');
  });
  constructorBuffer.writeln('\t});');

  return constructorBuffer.toString().removeLast();
}

String _buildSerializable(String modelName) {
  return '''
  
  factory $modelName.fromJson(Map<String, dynamic> json) => _\$${modelName}FromJson(json);
      
  Map<String, dynamic> toJson() => _\$${modelName}ToJson(this);''';
}

String _buildParse(String modelName, bool serializable) {
  return '''
  
  @override
  $modelName parse(data) {
    return $modelName.fromJson(data);
  }''';
}

String _buildDynamicParse(String modelName, bool serializable, bool iterable) {
  return '''
  
  @override
  dynamic dynamicParse(data) {
    List<$modelName>? list =
        (data as List<dynamic>).map((json) => $modelName.fromJson(json)).toList();
    return list;
  }''';
}

extension on String {
  String removeLast() {
    return substring(0, length - 1);
  }
}
